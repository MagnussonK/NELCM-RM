<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Childrens Museum - Unified Record Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="logo.png" type="image/png">
    <style>
        /* Global Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light background color */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            padding: 1.5rem;
        }
        .main-container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1), 0 4px 8px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 6xl; /* Increased max-width for overall app */
            border: 1px solid #e2e8f0;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        /* Section/View Specific Containers */
        .view-container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1), 0 4px 8px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            border: 1px solid #e2e8f0;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        #homeView { max-width: 6xl; }
        #addRecordView { max-width: 3xl; }
        #familyDetailsView { max-width: 5xl; }
        #recordDetailsView { max-width: 3xl; }
        #manageSecondaryMembersView { max-width: 4xl; }
        #addVisitView { max-width: 3xl; } /* New view for adding visits */
        #memberVisitsView { max-width: 4xl; } /* New view for displaying member visits */
        
        /* Form Group Styles */
        .form-group {
            margin-bottom: 1.25rem;
        }
        label {
            display: block;
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        input[type="datetime-local"], /* Added for visit_datetime */
        input[type="password"], /* Added for password fields */
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e0; /* gray-300 */
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #1f2937; /* gray-900 */
            transition: all 0.2s ease-in-out;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        input[type="datetime-local"]:focus, /* Added for visit_datetime */
        input[type="password"]:focus, /* Added for password fields */
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #5E237C; /* Custom purple from logo */
            box-shadow: 0 0 0 3px rgba(94, 35, 124, 0.25); /* Custom purple with opacity */
        }
        input:disabled {
            background-color: #e5e7eb;
            cursor: not-allowed;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 1.25rem;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 0.75rem;
            transform: scale(1.2); /* Slightly larger checkbox */
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 2rem;
        }
        .action-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary {
            background-color: #5E237C; /* Custom purple from logo */
            color: white;
            border: 1px solid #5E237C;
        }
        .btn-primary:hover {
            background-color: #4A1C63; /* Darker purple for hover */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-secondary {
            background-color: #99CC33; /* Custom green from logo */
            color: #374151; /* Dark gray for contrast */
            border: 1px solid #99CC33;
        }
        .btn-secondary:hover {
            background-color: #7AA329; /* Darker green for hover */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-delete {
            background-color: #ef4444; /* red-500 */
            color: white;
            border: 1px solid #ef4444;
        }
        .btn-delete:hover {
            background-color: #dc2626; /* red-600 */
        }

        /* Message Box */
        .message-box {
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 500;
        }
        .message-box.success {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .message-box.error {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background-color: #e2e8f0;
            color: #4a5568;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        tr:hover {
            background-color: #f7fafc;
        }
        .expired-membership-row {
            background-color: #fee2e2;
        }
        .expiring-soon-row {
            background-color: #fcd34d;
        }
        .founding-family-row {
            background-color: #dcfce7;
        }
        .missing-info-row {
            border-left: 4px solid #f59e0b;
        }
        @keyframes sparkle-pulse {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .sparkly-birthday-row {
            background: linear-gradient(90deg, #d8b4fe, #a78bfa, #5E237C, #a78bfa, #d8b4fe);
            background-size: 300% 100%;
            animation: sparkle-pulse 4s infinite linear;
            color: #fff;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px; width: 26px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #99CC33; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="text-center mb-6">
            <img src="logo.png" alt="The Childrens Museum Logo" class="mx-auto h-20 sm:h-24 mb-4">
        </div>

        <div id="messageBox" class="hidden p-3 mb-6 rounded-lg text-center font-medium transition-opacity duration-300 ease-in-out" role="alert"></div>

        <div id="globalLoadingIndicator" class="hidden text-center my-8 text-blue-600 font-semibold text-lg">
            <svg class="animate-spin h-8 w-8 mx-auto mb-3" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>Processing request, please wait...</p>
        </div>

        <section id="homeView" class="view-container">
            <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-6">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-800 to-indigo-900">
                    Record Manager
                </span>
            </h1>

            <div class="flex flex-col sm:flex-row items-center justify-between mb-8 space-y-4 sm:space-y-0 sm:space-x-6">
                <button id="homeFetchDataBtn" class="action-button btn-primary">Refresh Data</button>
                <button id="homeAddRecordBtn" class="action-button btn-secondary">Add New Record</button>
                <input type="text" id="homeLastNameSearch" placeholder="Search by Last Name..." class="w-full sm:w-auto flex-grow">
                <div class="flex items-center space-x-2">
                    <label for="showInactiveToggle" class="text-gray-700 font-medium">Show Inactive:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showInactiveToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div id="homeResultsContainer" class="mt-8">
                <div id="homeDataResults"><p>Loading data...</p></div>
            </div>

            <div class="mt-8 text-center flex flex-wrap justify-center items-center gap-4">
                <span id="homeMemberCount"></span> | <span id="homeUniqueMemberCount"></span> | <span id="homeVisitsTodayCount"></span>
            </div>

            <div class="mt-8 text-center flex flex-wrap justify-center items-center gap-4">
                <button id="homeGenerateReportBtn" class="action-button btn-primary">Generate Member Report</button>
                <button id="homeSendEmailsBtn" class="action-button btn-secondary">Send Renewal Emails</button>
            </div>
        </section>

        <section id="addRecordView" class="view-container hidden">
            <h1 id="addRecordHeader">Add New Member Record</h1>
            <form id="addRecordForm">
                <div class="form-group"><label for="addName">First Name:</label><input type="text" id="addName" required></div>
                <div class="form-group"><label for="addLastName">Last Name:</label><input type="text" id="addLastName" required></div>
                <div class="form-group"><label for="addEmail">Email:</label><input type="email" id="addEmail"></div>
                <div class="form-group"><label for="addPhone">Phone:</label><input type="tel" id="addPhone"></div>
                <div class="form-group"><label for="addAddress">Address:</label><input type="text" id="addAddress"></div>
                <div class="form-group"><label for="addCity">City:</label><input type="text" id="addCity" required></div>
                <div class="form-group"><label for="addState">State:</label><input type="text" id="addState"></div>
                <div class="form-group"><label for="addZipCode">Zip Code:</label><input type="text" id="addZipCode"></div>
                <div class="form-group"><label for="addBirthday">Birthday:</label><input type="date" id="addBirthday"></div>
                <div class="form-group"><label for="addGender">Gender:</label><select id="addGender"><option value="">Select</option><option value="true">Male</option><option value="false">Female</option></select></div>
                <div class="checkbox-group"><input type="checkbox" id="addFoundingFamily"><label for="addFoundingFamily">Founding Family</label></div>
                <div class="action-buttons">
                    <button type="submit" class="action-button btn-primary">Add Record</button>
                    <button type="button" id="addRecordCancelBtn" class="action-button btn-secondary">Cancel</button>
                </div>
            </form>
        </section>

        <section id="familyDetailsView" class="view-container hidden">
            <h1>Family Details</h1>
            <div id="familyDetailsContent"></div>
            <div class="action-buttons">
                <button id="familyDetailsManageSecondaryMembersBtn" class="action-button btn-primary">Manage Members</button>
                <button id="familyDetailsCloseBtn" class="action-button btn-secondary">Close</button>
            </div>
        </section>

        <section id="recordDetailsView" class="view-container hidden">
            <h1>Member Details: <span id="recordDetailsMemberIdDisplay"></span></h1>
            <form id="recordDetailForm">
                <div class="action-buttons">
                    <button type="submit" class="action-button btn-primary">Update Record</button>
                    <button type="button" id="recordDetailsDeleteRecordBtn" class="action-button btn-delete">Delete</button>
                    <button type="button" id="recordDetailsCloseBtn" class="action-button btn-secondary">Close</button>
                </div>
            </form>
        </section>

        <section id="manageSecondaryMembersView" class="view-container hidden">
             <h1>Manage Family Members for: <span id="manageSecondaryFamilyIdDisplay"></span></h1>
             <div id="manageSecondaryMembersTableContainer"></div>
             <form id="manageSecondaryAddForm">
                <div class="action-buttons">
                    <button type="submit" class="action-button btn-primary">Add Member</button>
                    <button type="button" id="manageSecondaryCloseBtn" class="action-button btn-secondary">Done</button>
                </div>
             </form>
        </section>
        
        <section id="addVisitView" class="view-container hidden">
            <h1>Record New Visit</h1>
            <form id="addVisitForm">
                <div class="action-buttons">
                    <button type="submit" class="action-button btn-primary">Record Visit</button>
                    <button type="button" id="addVisitCancelBtn" class="action-button btn-secondary">Cancel</button>
                </div>
            </form>
        </section>

        <section id="memberVisitsView" class="view-container hidden">
            <h1>Visit History</h1>
            <div id="calendarContainer"></div>
            <div id="allOtherVisitsContainer"></div>
            <div class="action-buttons">
                <button type="button" id="memberVisitsCloseBtn" class="action-button btn-secondary">Close</button>
            </div>
        </section>
    </div>
	
	<div id="todaysVisitsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <h3>Visitors Today</h3>
            <div id="todaysVisitsTableBody"></div>
            <button id="closeTodaysVisitsModalBtn">Close</button>
        </div>
    </div>

    <script>
        // --- Global Variables and Configuration ---
        let allData = [];
        const BASE_API_URL = 'https://7vyy10lcgd.execute-api.us-east-1.amazonaws.com/api';

        // --- DOM Element References ---
        const messageBox = document.getElementById('messageBox');
        const globalLoadingIndicator = document.getElementById('globalLoadingIndicator');
        const homeView = document.getElementById('homeView');
        const addRecordView = document.getElementById('addRecordView');
        const familyDetailsView = document.getElementById('familyDetailsView');
        const recordDetailsView = document.getElementById('recordDetailsView');
        const manageSecondaryMembersView = document.getElementById('manageSecondaryMembersView');
        const addVisitView = document.getElementById('addVisitView');
        const memberVisitsView = document.getElementById('memberVisitsView');
        
        // --- UI Utility Functions ---
        function showView(viewId) {
            const views = [homeView, addRecordView, familyDetailsView, recordDetailsView, manageSecondaryMembersView, addVisitView, memberVisitsView];
            views.forEach(v => v.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        function parseDateRobustly(dateString) {
            if (!dateString) return null;
            let date = new Date(dateString.split(' ')[0] + 'T00:00:00Z');
            return !isNaN(date.getTime()) ? date : null;
        }

        function formatDate(dateObj) {
            if (!dateObj) return 'N/A';
            return dateObj.toLocaleDateString('en-US', { timeZone: 'UTC' });
        }
        
        function formatDateForInput(dateObj) {
            if (!dateObj) return '';
            return dateObj.toISOString().split('T')[0];
        }

        // --- Home View Logic ---
        const homeFetchDataBtn = document.getElementById('homeFetchDataBtn');
        const homeAddRecordBtn = document.getElementById('homeAddRecordBtn');
        const homeLastNameSearchInput = document.getElementById('homeLastNameSearch');
        const showInactiveToggle = document.getElementById('showInactiveToggle');
        const homeSendEmailsBtn = document.getElementById('homeSendEmailsBtn');
        const homeGenerateReportBtn = document.getElementById('homeGenerateReportBtn');
        
        async function fetchAllData() {
            globalLoadingIndicator.classList.remove('hidden');
            try {
                const response = await fetch(`${BASE_API_URL}/data`);
                if (!response.ok) throw new Error('Network response was not ok.');
                allData = await response.json();
                filterHomeData();
            } catch (error) {
                showMessage('Failed to fetch data.', 'error');
            } finally {
                globalLoadingIndicator.classList.add('hidden');
            }
        }

        function renderHomeTable(dataToRender) {
            const tableContainer = document.getElementById('homeDataResults');
            if (dataToRender.length === 0) {
                tableContainer.innerHTML = '<p>No records found.</p>';
                return;
            }

            const today = new Date();
            const todayMonth = today.getUTCMonth();
            const todayYear = today.getUTCFullYear();
            
            let tableHtml = '<table class="min-w-full divide-y divide-gray-200"><thead><tr><th>Status</th><th>Last Name</th><th>First Name</th><th>Expires</th><th>Active</th><th>Actions</th></tr></thead><tbody>';
            dataToRender.forEach(row => {
                let showNoticeIcon = false;
                if (!row.renewal_email_sent && !row.founding_family) {
                    const expirationDate = parseDateRobustly(row.membership_expires);
                    if (expirationDate) {
                        if (expirationDate.getUTCMonth() === todayMonth && expirationDate.getUTCFullYear() === todayYear) {
                            showNoticeIcon = true;
                        }
                    }
                }
                
                tableHtml += `<tr data-id="${row.member_id}">
                    <td>${showNoticeIcon ? '&#9993;' : ''}</td>
                    <td>${row.last_name}</td>
                    <td>${row.name}</td>
                    <td>${formatDate(parseDateRobustly(row.membership_expires))}</td>
                    <td>${row.active_flag ? 'Yes' : 'No'}</td>
                    <td><button onclick="checkInFamily('${row.member_id}')">Check-in</button></td>
                </tr>`;
            });
            tableHtml += '</tbody></table>';
            tableContainer.innerHTML = tableHtml;

            document.querySelectorAll('#homeDataResults tbody tr').forEach(rowEl => {
                rowEl.addEventListener('click', () => {
                    // Logic to show family details view
                });
            });
        }

        function filterHomeData() {
            const searchTerm = homeLastNameSearchInput.value.toLowerCase();
            const showInactive = showInactiveToggle.checked;
            const primaryMembers = allData.filter(m => m.primary_member);
            
            const filtered = primaryMembers.filter(m => {
                const lastNameMatch = (m.last_name || '').toLowerCase().includes(searchTerm);
                const activeMatch = showInactive || m.active_flag;
                return lastNameMatch && activeMatch;
            });
            renderHomeTable(filtered);
        }
        
        async function sendRenewalEmails() {
            if (!confirm("Are you sure you want to send renewal emails?")) return;
            globalLoadingIndicator.classList.remove('hidden');
            try {
                const response = await fetch(`${BASE_API_URL}/send_renewal_emails`, { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                showMessage(result.message, 'success');
                await fetchAllData();
            } catch (error) {
                showMessage(`Failed to send emails: ${error.message}`, 'error');
            } finally {
                globalLoadingIndicator.classList.add('hidden');
            }
        }

        homeFetchDataBtn.addEventListener('click', fetchAllData);
        homeAddRecordBtn.addEventListener('click', () => showView('addRecordView'));
        homeLastNameSearchInput.addEventListener('input', filterHomeData);
        showInactiveToggle.addEventListener('change', filterHomeData);
        homeSendEmailsBtn.addEventListener('click', sendRenewalEmails);
        homeGenerateReportBtn.addEventListener('click', () => { /* Logic to generate CSV */ });

        // --- Family Details Logic ---
        let primaryMemberRecord = null;
        const updateMembershipBtn = document.getElementById('updateMembershipBtn'); // Assume this exists in the final HTML
        if (updateMembershipBtn) {
            updateMembershipBtn.addEventListener('click', async () => {
                if (!primaryMemberRecord) return;
                const newMemStartDateISO = new Date().toISOString().split('T')[0];
                const updatedData = {
                    mem_start_date: newMemStartDateISO,
                    active_flag: true,
                    is_primary: true,
                    email: primaryMemberRecord.email,
                    name: primaryMemberRecord.name,
                    last_name: primaryMemberRecord.last_name
                };
                const response = await fetch(`${BASE_API_URL}/update_record/${primaryMemberRecord.member_id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                // ... handle response
            });
        }
        
        // --- Add Record, Record Details, etc. ---
        // Placeholder for the rest of the application logic which would be substantial

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', fetchAllData);
    </script>
</body>
</html>