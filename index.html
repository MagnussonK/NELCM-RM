<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Childrens Museum - Unified Record Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="logo.png" type="image/png">
    
    <link rel="stylesheet" href="app.css">
</head>
<body>
    <div class="main-container">
        <div class="text-center mb-6">
            <img src="logo.png" alt="The Childrens Museum Logo" class="mx-auto h-20 sm:h-24 mb-4">
        </div>
		<div class="flex items-center gap-2">
			<button id="btnSignIn"  type="button">Sign in</button>
			<button id="btnSignOut" type="button" hidden>Sign out</button>
			<span id="userBadge" style="margin-left:.5rem;"></span>
		</div>

        <div id="messageBox" class="hidden p-3 mb-6 rounded-lg text-center font-medium transition-opacity duration-300 ease-in-out" role="alert"></div>

        <div id="globalLoadingIndicator" class="hidden text-center my-8 text-blue-600 font-semibold text-lg">
            <svg class="animate-spin h-8 w-8 mx-auto mb-3" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p>Processing request, please wait...</p>
        </div>

        <section id="homeView" class="view-container">
            <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-6">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-800 to-indigo-900">
                    Record Manager
                </span>
            </h1>

            <div class="flex flex-col sm:flex-row items-center justify-between mb-8 space-y-4 sm:space-y-0 sm:space-x-6">
                <button
                    id="homeFetchDataBtn"
                    class="w-full sm:w-auto flex-shrink-0 bg-gradient-to-r from-purple-800 to-indigo-900 text-white py-3 px-8 rounded-full font-semibold text-lg
                           hover:from-purple-900 hover:to-indigo-950 focus:outline-none focus:ring-4 focus:ring-purple-300 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
                >
                    <svg class="animate-spin h-5 w-5 mr-3 hidden" id="homeRefreshSpinner" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Refresh Data
                </button>

                <button
                    id="homeAddRecordBtn"
                    class="w-full sm:w-auto flex-shrink-0 bg-gradient-to-r from-lime-500 to-green-600 text-white py-3 px-8 rounded-full font-semibold text-lg
                           hover:from-lime-600 hover:to-green-700 focus:outline-none focus:ring-4 focus:ring-lime-300 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
                >
                    Add New Record
                </button>

                <div class="w-full sm:w-auto flex-grow flex items-center bg-gray-100 border border-gray-300 rounded-full py-2 px-4 shadow-inner focus-within:ring-2 focus-within:ring-purple-500 transition duration-200">
                    <input
                        type="text"
                        id="homeLastNameSearch"
                        placeholder="Search by Last Name (type to filter)..."
                        class="flex-grow bg-transparent p-1 text-gray-800 placeholder-gray-500 outline-none"
                    />
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>

                <div class="flex items-center space-x-2">
                    <label for="showInactiveToggle" class="text-gray-700 font-medium">Show Inactive Accounts:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showInactiveToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div id="homeResultsContainer" class="mt-8 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-inner overflow-x-auto max-h-96">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Current Records:</h2>
                <div id="homeDataResults" class="bg-white rounded-lg text-gray-800 text-sm overflow-hidden">
                    <p class="text-center text-gray-500 py-4">Loading data...</p>
                </div>
            </div>

            <div class="mt-8 p-4 bg-gray-100 rounded-lg border border-gray-200 text-center text-gray-700 font-semibold flex flex-col sm:flex-row justify-around items-center space-y-2 sm:space-y-0">
                <div class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h-5v-2a3 3 0 013-3h2a3 3 0 013 3v2h-5z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 10a3 3 0 11-6 0 3 3 0 016 0zm-7 8a4 4 0 014-4h4a4 4 0 014 4v2H4v-2z" />
                    </svg>
                    <span id="homeMemberCount">Total Active Family Members: 0</span>
                </div>
                <div class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-lime-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l7 7m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span id="homeUniqueMemberCount">Total Active Families: 0</span>
                </div>
                <div id="visitsTodayContainer" class="flex items-center space-x-2 cursor-pointer hover:bg-gray-200 p-2 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span id="homeVisitsTodayCount">Visits Today: 0</span>
                </div>
            </div>

            <div class="mt-8 text-center flex justify-center items-center gap-4">
                <button
                    id="homeGenerateReportBtn"
                    class="bg-gradient-to-r from-purple-800 to-indigo-900 text-white py-3 px-8 rounded-full font-semibold text-lg
                           hover:from-purple-900 hover:to-indigo-950 focus:outline-none focus:ring-4 focus:ring-purple-300 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
                >
                    Generate Member Report
                </button>

                <button
                    id="homeSendEmailsBtn"
                    class="bg-gradient-to-r from-blue-500 to-teal-600 text-white py-3 px-8 rounded-full font-semibold text-lg
                           hover:from-blue-600 hover:to-teal-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300 ease-in-out transform hover:scale-105 shadow-lg"
                >
                    Send Renewal Emails
                </button>
            </div>
        </section>

        <section id="addRecordView" class="view-container hidden">
            <h1 id="addRecordHeader" class="text-3xl font-extrabold text-center text-gray-900 mb-6">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-800 to-indigo-900">
                    Add New Member Record
                </span>
            </h1>

            <form id="addRecordForm">
                <div class="form-group">
                    <label for="addName">First Name:</label>
                    <input type="text" id="addName" required>
                </div>

                <div class="form-group">
                    <label for="addLastName">Last Name:</label>
                    <input type="text" id="addLastName" required>
                </div>

                <div class="form-group">
                    <label for="addEmail">Email:</label>
                    <input type="email" id="addEmail">
                </div>

                <div class="form-group">
                    <label for="addPhone">Phone:</label>
                    <input type="tel" id="addPhone" placeholder="e.g., 123-456-7890">
                </div>

                <div class="form-group">
                    <label for="addAddress">Address:</label>
                    <input type="text" id="addAddress">
                </div>

                <div class="form-group">
                    <label for="addCity">City:</label>
                    <input type="text" id="addCity" required>
                </div>

                <div class="form-group">
                    <label for="addState">State:</label>
                    <input type="text" id="addState" maxlength="2" placeholder="e.g., LA">
                </div>

                <div class="form-group">
                    <label for="addZipCode">Zip Code:</label>
                    <input type="text" id="addZipCode" pattern="[0-9]{5}(-[0-9]{4})?" placeholder="e.g., 71291 or 71291-1234">
                </div>

                <div class="form-group">
                    <label for="addBirthday">Birthday:</label>
                    <input type="date" id="addBirthday">
                </div>

                <div class="form-group">
                    <label for="addGender">Gender:</label>
                    <select id="addGender">
                        <option value="">Select Gender</option>
                        <option value="true">Male</option>
                        <option value="false">Female</option>
                    </select>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="addFoundingFamily">
                    <label for="addFoundingFamily" class="mb-0">Founding Family</label>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="action-button btn-primary">Add Record</button>
                    <button type="button" id="addFamilyMembersBtn" class="action-button btn-primary hidden">Add Family Members</button>
                    <button type="button" id="addRecordCancelBtn" class="action-button btn-secondary">Cancel</button>
                </div>
            </form>
        </section>

        <section id="familyDetailsView" class="view-container hidden">
            <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-6">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-800 to-indigo-900">
                    Family Details
                </span>
            </h1>

            <div id="familyDetailsContent">
                <section class="mb-8">
                    <h2 class="section-header">Family Overview (<span id="displayMemberId"></span>)</h2>
                    <div class="detail-grid">
						<div class="detail-item">
							<span class="detail-label">Address & Email:</span>
							<span id="familyAddress" class="detail-value"></span>
							<span id="familyCityStateZip" class="detail-value"></span>
							<span id="familyEmail" class="detail-value mt-2 text-indigo-600 font-semibold"></span>
						</div>
						<div id="updateMembershipContainer" class="detail-item">
                            <span class="detail-label font-bold text-base mb-3 border-b pb-2">Membership Dates:</span>
                            <div class="flex items-end gap-4 pt-2">
                                <div class="flex-grow space-y-3">
                                    <div>
                                        <label class="detail-label text-sm !mb-1">Start Date:</label>
                                        <span id="familyMemStartDateDisplay" class="detail-value block p-2 bg-gray-200 rounded-md w-full text-center font-medium"></span>
                                    </div>
                                    <div>
                                        <label class="detail-label text-sm !mb-1">End Date:</label>
                                        <span id="familyMembershipExpires" class="detail-value block p-2 bg-gray-200 rounded-md w-full text-center font-medium"></span>
                                    </div>
                                </div>
                                <div class="flex-shrink-0">
                                    <button id="updateMembershipBtn" class="action-button btn-primary">
                                        Update Membership
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h2 class="section-header">Individual Family Members</h2>
                    <div id="individualMembersList">
                        <p class="text-gray-600 text-center py-4">No individual members found for this family.</p>
                    </div>
                </section>
            </div>

            <div class="action-buttons">
                <button id="familyDetailsManageSecondaryMembersBtn" class="action-button btn-primary">
                    Manage Secondary Members
                </button>
                <button id="familyDetailsCloseBtn" class="action-button btn-secondary">
                    Close Window
                </button>
            </div>
        </section>

        <section id="recordDetailsView" class="view-container hidden">
            <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-6">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-800 to-indigo-900">
                    Member Details: <span id="recordDetailsMemberIdDisplay"></span>
                </span>
            </h1>

            <form id="recordDetailForm">
                <div class="form-group">
                    <label for="recordDetailsName">First Name:</label>
                    <input type="text" id="recordDetailsName" required>
                </div>

                <div class="form-group">
                    <label for="recordDetailsLastName">Last Name:</label>
                    <input type="text" id="recordDetailsLastName" required>
                </div>

                <div class="form-group">
                    <label for="recordDetailsEmail">Email:</label>
                    <input type="email" id="recordDetailsEmail" disabled>
                </div>

                <div class="form-group">
                    <label for="recordDetailsPhone">Phone:</label>
                    <input type="tel" id="recordDetailsPhone">
                </div>

                <div class="form-group">
                    <label for="recordDetailsAddress">Address:</label>
                    <input type="text" id="recordDetailsAddress" disabled>
                </div>

                <div class="form-group">
                    <label for="recordDetailsCity">City:</label>
                    <input type="text" id="recordDetailsCity" required disabled>
                </div>

                <div class="form-group">
                    <label for="recordDetailsState">State:</label>
                    <input type="text" id="recordDetailsState" maxlength="2" disabled>
                </div>

                <div class="form-group">
                    <label for="recordDetailsZipCode">Zip Code:</label>
                    <input type="text" id="recordDetailsZipCode" disabled>
                </div>

                <div class="form-group">
                    <label for="recordDetailsBirthday">Birthday:</label>
                    <input type="date" id="recordDetailsBirthday">
                </div>

                <div class="form-group">
                    <label for="recordDetailsGender">Gender:</label>
                    <select id="recordDetailsGender">
                        <option value="">Select Gender</option>
                        <option value="true">Male</option>
                        <option value="false">Female</option>
                    </select>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="recordDetailsFoundingFamily" disabled>
                    <label for="recordDetailsFoundingFamily" class="mb-0">Founding Family</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="recordDetailsPrimaryMember" disabled>
                    <label for="recordDetailsPrimaryMember" class="mb-0">Primary Member</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="recordDetailsSecondaryMember" disabled>
                    <label for="recordDetailsSecondaryMember" class="mb-0">Secondary Member</label>
                </div>

                <div class="form-group">
                    <label for="recordDetailsMemStartDate">Membership Start Date:</label>
                    <input type="date" id="recordDetailsMemStartDate" disabled>
                </div>

                <div class="form-group" id="recordDetailsMembershipExpiresContainer">
                    <label for="recordDetailsMembershipExpires">Membership Expires:</label>
                    <input type="date" id="recordDetailsMembershipExpires" disabled>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="recordDetailsActiveFlag" disabled>
                    <label for="recordDetailsActiveFlag" class="mb-0">Active</label>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="action-button btn-primary">Update Record</button>
                    <button type="button" id="recordDetailsDeleteRecordBtn" class="action-button btn-delete">Delete Record</button>
                    <button type="button" id="recordDetailsCloseBtn" class="action-button btn-secondary">Close</button>
                </div>
            </form>
        </section>

        <section id="manageSecondaryMembersView" class="view-container hidden">
            <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-6">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-800 to-indigo-900">
                    Manage Family Members for: <span id="manageSecondaryFamilyIdDisplay">Loading...</span>
                </span>
            </h1>

            <h2 class="text-xl font-bold text-gray-800 mb-4">Current Family Members:</h2>
            <div id="manageSecondaryMembersTableContainer" class="overflow-x-auto max-h-60 mb-6 border border-gray-200 rounded-lg shadow-inner">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3">Name</th>
                            <th class="px-6 py-3">Last Name</th>
                            <th class="px-6 py-3">Role</th>
                            <th class="px-6 py-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="manageSecondaryMembersTableBody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="4" class="text-center py-4 text-gray-500">No family members found.</td></tr>
                    </tbody>
                </table>
            </div>

            <h2 class="text-xl font-bold text-gray-800 mb-4 mt-8">Add New Secondary Member:</h2>
            <form id="manageSecondaryAddForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="manageSecondaryName">First Name:</label>
                        <input type="text" id="manageSecondaryName" required>
                    </div>

                    <div class="form-group">
                        <label for="manageSecondaryLastName">Last Name:</label>
                        <input type="text" id="manageSecondaryLastName" required>
                    </div>

                    <div class="form-group">
                        <label for="manageSecondaryPhone">Phone (Optional):</label>
                        <input type="tel" id="manageSecondaryPhone" placeholder="e.g., 123-456-7890">
                    </div>

                    <div class="form-group">
                        <label for="manageSecondaryBirthday">Birthday (Optional):</label>
                        <input type="date" id="manageSecondaryBirthday">
                    </div>

                    <div class="form-group">
                        <label for="manageSecondaryGender">Gender (Optional):</label>
                        <select id="manageSecondaryGender">
                            <option value="">Select Gender</option>
                            <option value="true">Male</option>
                            <option value="false">Female</option>
                        </select>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="action-button btn-primary">Add Secondary Member</button>
                    <button type="button" id="manageSecondaryCloseBtn" class="action-button btn-secondary">Done</button>
                </div>
            </form>
        </section>

        <section id="addVisitView" class="view-container hidden">
            <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-6">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-800 to-indigo-900">
                    Record New Visit
                </span>
            </h1>

            <form id="addVisitForm">
                <div class="form-group">
                    <label for="addVisitMemberId">Member ID:</label>
                    <input type="text" id="addVisitMemberId" disabled>
                </div>
                <div class="form-group">
                    <label for="addVisitName">First Name:</label>
                    <input type="text" id="addVisitName" disabled>
                </div>
                <div class="form-group">
                    <label for="addVisitLastName">Last Name:</label>
                    <input type="text" id="addVisitLastName" disabled>
                </div>
                <div class="form-group">
                    <label for="addVisitDateTime">Visit Date and Time:</label>
                    <input type="datetime-local" id="addVisitDateTime" required>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="action-button btn-primary">Record Visit</button>
                    <button type="button" id="addVisitCancelBtn" class="action-button btn-secondary">Cancel</button>
                </div>
            </form>
        </section>

        <section id="memberVisitsView" class="view-container hidden">
            <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-6">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-800 to-indigo-900">
                    Visit History for: <span id="memberVisitsDisplayName"></span> (<span id="memberVisitsDisplayId"></span>)
                </span>
            </h1>

            <div class="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200 text-purple-800 font-semibold text-lg text-center">
                Total Visits: <span id="visitsSinceMembershipCount">0</span>
            </div>

            <h2 class="section-header">Visit Calendar</h2>
            <div id="calendarContainer" class="calendar">
                <div class="calendar-header">
                    <button id="prevMonthBtn">&lt;</button>
                    <span id="currentMonthYear"></span>
                    <button id="nextMonthBtn">&gt;</button>
                </div>
                <div class="calendar-weekdays">
                    <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                </div>
                <div id="calendarDays" class="calendar-days">
                </div>
            </div>

            <h2 class="section-header mt-8">All Other Visits</h2>
            <div id="allOtherVisitsContainer" class="all-visits-scroll-area">
                <p class="text-gray-600 text-center py-4">No older visits to display.</p>
            </div>

            <div class="action-buttons">
                <button type="button" id="memberVisitsCloseBtn" class="action-button btn-secondary">Close</button>
            </div>
        </section>

    </div>
	
	<div id="todaysVisitsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-2xl leading-6 font-bold text-gray-900 mb-4">Visitors Today</h3>
                <div class="mt-2 px-7 py-3 max-h-96 overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Family</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Visitors</th>
                            </tr>
                        </thead>
                        <tbody id="todaysVisitsTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                    <p id="noVisitsMessage" class="hidden text-gray-500 py-4">No visits have been recorded yet today.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeTodaysVisitsModalBtn" class="px-4 py-2 bg-purple-800 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-purple-900 focus:outline-none focus:ring-2 focus:ring-purple-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- Robust Amplify loader + init (with CDN fallback) -->
<script>
  // Ensure BASE_API_URL exists
  window.BASE_API_URL = window.BASE_API_URL || 'https://7vyy10lcgd.execute-api.us-east-1.amazonaws.com/api';

  (function () {
    function initAmplify() {
      if (!window.aws_amplify) {
        console.error('Amplify UMD still not loaded');
        return;
      }
      const { Amplify, Auth } = window.aws_amplify;

      Amplify.configure({
        Auth: {
          region: 'us-east-1',
          userPoolId: 'us-east-1_DbvqrCJkl',
          userPoolWebClientId: 'kd7ovn5929vlj8fpi1f7gvbv4',
          oauth: {
            domain: 'nelcm.auth.us-east-1.amazoncognito.com',
            scope: ['openid','email','profile'],
            redirectSignIn: window.location.origin + '/',
            redirectSignOut: window.location.origin + '/',
            responseType: 'code'
          },
          storage: window.localStorage
        }
      });

      // expose for app.js
      window.Auth = Auth;
      window.apiFetch = async function (path, init = {}) {
        try {
          const t = (await Auth.currentSession()).getIdToken().getJwtToken();
          init.headers = { ...(init.headers || {}), Authorization: `Bearer ${t}` };
        } catch { /* not signed in; call may 401 */ }
        return fetch(window.BASE_API_URL + path, init);
      };

	  <!-- inside initAmplify(), after setting window.apiFetch and wiring buttons -->
	  window.dispatchEvent(new Event('auth-ready'));

	  if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', () => {
      if (window.apiFetch) startApp();
        else window.addEventListener('auth-ready', startApp, { once: true });
        });
      } else {
      if (window.apiFetch) startApp();
        else window.addEventListener('auth-ready', startApp, { once: true });
      }

	  // optional: wire buttons if they exist
      const btnIn  = document.getElementById('btnSignIn');
      const btnOut = document.getElementById('btnSignOut');
      const badge  = document.getElementById('userBadge');

      if (btnIn && !btnIn.__wired)  { btnIn.__wired  = true; btnIn.addEventListener('click', () => Auth.federatedSignIn()); }
      if (btnOut && !btnOut.__wired){ btnOut.__wired = true; btnOut.addEventListener('click', () => Auth.signOut()); }

      // simple UI toggle
      Auth.currentSession().then(s => {
        btnIn && (btnIn.hidden = true);
        btnOut && (btnOut.hidden = false);
        if (badge) badge.textContent = s.getIdToken().payload.email || 'Signed in';
      }).catch(() => {
        btnIn && (btnIn.hidden = false);
        btnOut && (btnOut.hidden = true);
        if (badge) badge.textContent = '';
      });
    }

    function loadAmplifyAndInit() {
      // If loaded already, init now
      if (window.aws_amplify) return initAmplify();

      // Try unpkg first
      const s = document.createElement('script');
      s.src = 'https://unpkg.com/aws-amplify@5/dist/aws-amplify.min.js';
      s.defer = true;
      s.onload = initAmplify;
      s.onerror = function () {
        // Fallback to jsDelivr pinned version
        const f = document.createElement('script');
        f.src = 'https://cdn.jsdelivr.net/npm/aws-amplify@5.3.21/dist/aws-amplify.min.js';
        f.defer = true;
        f.onload = initAmplify;
        f.onerror = () => console.error('Failed to load Amplify from both CDNs');
        document.head.appendChild(f);
      };
      document.head.appendChild(s);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAmplifyAndInit);
    } else {
      loadAmplifyAndInit();
    }
  })();
</script>

<script defer src="app.js"></script>

</body>
</html>